name: Build Docker, Update Manifests for Argo CD on Tag

on:
  push:
    tags:
      - 'v*.*.*'

env:
  IMAGE_REGISTRY: ghcr.io

permissions:
  contents: write
  packages: write

jobs:
  build_and_push_docker_image:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.image_meta_output.outputs.version }}
      image_name: ${{ env.IMAGE_REGISTRY }}/${{ github.repository_owner }}/${{ env.REPO_NAME }}
    env:
      REPO_NAME: ${{ github.event.repository.name }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.IMAGE_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_REGISTRY }}/${{ github.repository_owner }}/${{ env.REPO_NAME }}
          tags: |
            type=ref,event=tag

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./app
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Set image tag output
        id: image_meta_output
        run: echo "version=${{ steps.meta.outputs.version }}" >> $GITHUB_OUTPUT

  update_manifest_dev:
    name: Update Development Manifest
    needs: build_and_push_docker_image
    runs-on: ubuntu-latest
    environment:
      name: development
    env:
      MANIFEST_FILE: "./k8s/overlays/development/deployment.yaml"
      GIT_COMMIT_MESSAGE: "Update dev deployment image to ${{ needs.build_and_push_docker_image.outputs.image_tag }} [skip ci]"
    steps:
      - name: Check Tag for Alpha
        run: |
          TAG_NAME="${{ github.ref_name }}"
          if ! echo "$TAG_NAME" | grep -i "alpha" > /dev/null; then
            echo "Tag $TAG_NAME does not contain 'alpha', skipping dev manifest update"
            exit 1
          fi
          echo "Tag $TAG_NAME contains 'alpha', proceeding with dev manifest update"
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Install yq
        run: |
          if ! command -v yq &> /dev/null; then
            sudo wget https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64 -O /usr/bin/yq
            sudo chmod +x /usr/bin/yq
          fi
          yq --version

      - name: Update Kubernetes Manifest
        env:
          NEW_IMAGE_WITH_TAG: "${{ needs.build_and_push_docker_image.outputs.image_name }}:${{ needs.build_and_push_docker_image.outputs.image_tag }}"
        run: |
          echo "Current tag: ${{ github.ref_name }}"
          echo "Updating $MANIFEST_FILE with image: $NEW_IMAGE_WITH_TAG"
          if [ ! -f "$MANIFEST_FILE" ]; then
            echo "Error: $MANIFEST_FILE not found"
            exit 1
          fi
          if ! yq e '.spec.template.spec.containers[0]' "$MANIFEST_FILE" > /dev/null; then
            echo "Error: No container found in $MANIFEST_FILE"
            exit 1
          fi
          yq e '.spec.template.spec.containers[0].image = strenv(NEW_IMAGE_WITH_TAG)' -i "$MANIFEST_FILE"
          cat "$MANIFEST_FILE"

      - name: Commit and Push Manifest Changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add "$MANIFEST_FILE"
          if git diff --staged --quiet; then
            echo "No changes to commit to $MANIFEST_FILE."
          else
            git commit -m "${{ env.GIT_COMMIT_MESSAGE }}"
            git push
            echo "Pushed manifest changes for development."
          fi

  update_manifest_staging:
    name: Update Staging Manifest
    needs: build_and_push_docker_image
    runs-on: ubuntu-latest
    environment:
      name: staging
    env:
      MANIFEST_FILE: "./k8s/overlays/staging/deployment.yaml"
      GIT_COMMIT_MESSAGE: "Update staging deployment image to ${{ needs.build_and_push_docker_image.outputs.image_tag }} [skip ci]"
    steps:
      - name: Check Tag for Beta
        run: |
          TAG_NAME="${{ github.ref_name }}"
          if ! echo "$TAG_NAME" | grep -i "beta" > /dev/null; then
            echo "Tag $TAG_NAME does not contain 'beta', skipping staging manifest update"
            exit 1
          fi
          echo "Tag $TAG_NAME contains 'beta', proceeding with staging manifest update"
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Install yq
        run: |
          if ! command -v yq &> /dev/null; then
            sudo wget https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64 -O /usr/bin/yq
            sudo chmod +x /usr/bin/yq
          fi
          yq --version

      - name: Update Kubernetes Manifest
        env:
          NEW_IMAGE_WITH_TAG: "${{ needs.build_and_push_docker_image.outputs.image_name }}:${{ needs.build_and_push_docker_image.outputs.image_tag }}"
        run: |
          echo "Current tag: ${{ github.ref_name }}"
          echo "Updating $MANIFEST_FILE with image: $NEW_IMAGE_WITH_TAG"
          if [ ! -f "$MANIFEST_FILE" ]; then
            echo "Error: $MANIFEST_FILE not found"
            exit 1
          fi
          if ! yq e '.spec.template.spec.containers[0]' "$MANIFEST_FILE" > /dev/null; then
            echo "Error: No container found in $MANIFEST_FILE"
            exit 1
          fi
          yq e '.spec.template.spec.containers[0].image = strenv(NEW_IMAGE_WITH_TAG)' -i "$MANIFEST_FILE"
          cat "$MANIFEST_FILE"

      - name: Commit and Push Manifest Changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add "$MANIFEST_FILE"
          if git diff --staged --quiet; then
            echo "No changes to commit to $MANIFEST_FILE."
          else
            git commit -m "${{ env.GIT_COMMIT_MESSAGE }}"
            git push
            echo "Pushed manifest changes for staging."
          fi

  update_manifest_production:
    name: Update Production Manifest
    needs: build_and_push_docker_image
    runs-on: ubuntu-latest
    environment:
      name: production
    env:
      MANIFEST_FILE: "./k8s/overlays/production/deployment.yaml"
      GIT_COMMIT_MESSAGE: "Update production deployment image to ${{ needs.build_and_push_docker_image.outputs.image_tag }} [skip ci]"
    steps:
      - name: Check Tag for Production
        run: |
          TAG_NAME="${{ github.ref_name }}"
          if echo "$TAG_NAME" | grep -i "alpha" > /dev/null || echo "$TAG_NAME" | grep -i "beta" > /dev/null; then
            echo "Tag $TAG_NAME contains 'alpha' or 'beta', skipping production manifest update"
            exit 1
          fi
          echo "Tag $TAG_NAME does not contain 'alpha' or 'beta', proceeding with production manifest update"
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Install yq
        run: |
          if ! command -v yq &> /dev/null; then
            sudo wget https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64 -O /usr/bin/yq
            sudo chmod +x /usr/bin/yq
          fi
          yq --version

      - name: Update Kubernetes Manifest
        env:
          NEW_IMAGE_WITH_TAG: "${{ needs.build_and_push_docker_image.outputs.image_name }}:${{ needs.build_and_push_docker_image.outputs.image_tag }}"
        run: |
          echo "Current tag: ${{ github.ref_name }}"
          echo "Updating $MANIFEST_FILE with image: $NEW_IMAGE_WITH_TAG"
          if [ ! -f "$MANIFEST_FILE" ]; then
            echo "Error: $MANIFEST_FILE not found"
            exit 1
          fi
          if ! yq e '.spec.template.spec.containers[0]' "$MANIFEST_FILE" > /dev/null; then
            echo "Error: No container found in $MANIFEST_FILE"
            exit 1
          fi
          yq e '.spec.template.spec.containers[0].image = strenv(NEW_IMAGE_WITH_TAG)' -i "$MANIFEST_FILE"
          cat "$MANIFEST_FILE"

      - name: Commit and Push Manifest Changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add "$MANIFEST_FILE"
          if git diff --staged --quiet; then
            echo "No changes to commit to $MANIFEST_FILE."
          else
            git commit -m "${{ env.GIT_COMMIT_MESSAGE }}"
            git push
            echo "Pushed manifest changes for production."
          fi
